<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard 3D - SuperTech Farm Control PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <style>
        /* Estilo de emerg√™ncia para garantir o fundo das modais */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.85) !important;
            backdrop-filter: blur(15px) !important;
            -webkit-backdrop-filter: blur(15px) !important;
        }
    </style>
</head>
<body class="dashboard-theme">

    <div id="fullScreenSuccess" class="fullscreen-overlay">
        <div class="success-content">
            <div class="sophisticated-check">
                <svg viewBox="0 0 100 100">
                    <circle class="bg-circle" cx="50" cy="50" r="45"/>
                    <path class="check-path" d="M30 50 L45 65 L70 35"/>
                </svg>
            </div>
            <h1 class="success-title">Conclu√≠do</h1>
            <p id="subtituloSucesso" class="success-subtitle">Sincronizando com a impressora...</p>
        </div>
    </div>

    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <img src="/static/img/logo.png" alt="Logo" class="brand-logo">
                <div class="brand-text">
                    <span class="brand-name">SuperTech <span class="orange">3D</span></span>
                    <span class="brand-sub">Farm Control</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <a href="#" class="nav-item active"><span class="icon">üìä</span> Dashboard</a>
                <a href="#" class="nav-item"><span class="icon">üìÇ</span> Biblioteca G-Code</a>
                <a href="#" class="nav-item"><span class="icon">üìà</span> Estat√≠sticas</a>
                <a href="#" class="nav-item"><span class="icon">‚öôÔ∏è</span> Configura√ß√µes</a>
            </nav>

            <button class="status-toggler" onclick="toggleStatusDrawer()">
                <span class="icon">üìä</span> <span class="label">Status Farm</span>
            </button>

            <div class="sidebar-footer">
                <button onclick="abrirModalCadastro()" class="btn-new-printer top-btn">
        + Nova Impressora
    </button>
            </div>
        </aside>

        <main class="main-viewport">
            <header class="top-bar">
                <div class="welcome-text">
                    <h1>Ol√°, Robson!</h1>
                    <p>Monitoramento de Farm - <strong>Betim</strong></p>
                </div>
                <div class="top-bar-actions">
                
                </div>
                <div id="statusOverlay" class="status-drawer-overlay" onclick="toggleStatusDrawer()"></div>
            </header>

            <section class="summary-widgets">
                <div class="widget-card main-stats">
                    <h3>Status Geral</h3>
                    <div class="stats-row">
                        <div class="stat-box">
                            <span class="val" id="countDisp">{{ disponiveis }}</span>
                            <span class="lbl">Prontas</span>
                        </div>
                        <div class="stat-box">
                            <span class="val highlight">{{ impressoras|length }}</span>
                            <span class="lbl">Total M√°quinas</span>
                        </div>
                    </div>
                </div>

                <div class="widget-card glass production-widget">
                    <div class="production-header"><span class="widget-icon">‚ö°</span><h4>Linha de Produ√ß√£o</h4></div>
                    <div class="production-scroll-area">
                        <ul id="listaProducaoAtiva" class="production-list">
                            <li class="empty-msg">Aguardando in√≠cio...</li>
                        </ul>
                    </div>
                </div>

                <div class="widget-card glass production-widget">
                    <div class="production-header"><span class="widget-icon">‚úÖ</span><h4>Conclu√≠dos (24h)</h4></div>
                    <div class="production-scroll-area">
                        <ul id="listaProducaoConcluida" class="production-list">
                            <li class="empty-msg">Nenhuma pe√ßa hoje</li>
                        </ul>
                    </div>
                </div>
            </section>

            <div class="grid-responsive">
                {% for ip, dados in impressoras.items() %}
                <section class="card-pro {{ dados.cor }}" onclick="abrirModal('{{ ip }}', '{{ dados.nome }}')">
                    <button class="btn-emergency-stop" onclick="event.stopPropagation(); paradaDeEmergencia('{{ ip }}', '{{ dados.nome }}')">
    ‚ö†Ô∏è
</button>
                    
                    <div class="card-loader-overlay" id="loader-{{ ip | replace('.', '-') }}" style="display: none;">
                        <div class="mini-loader-content" id="content-{{ ip | replace('.', '-') }}">
                            <div class="mini-upload-track"><div class="mini-upload-fill" id="fill-{{ ip | replace('.', '-') }}"></div></div>
                            <div class="mini-status-row"><span id="pct-{{ ip | replace('.', '-') }}">0%</span><p id="msg-{{ ip | replace('.', '-') }}">Enviando...</p></div>
                        </div>
                        <div class="mini-success-view" id="success-{{ ip | replace('.', '-') }}" style="display: none;">
                            <div class="sophisticated-check mini"><svg viewBox="0 0 100 100"><circle class="bg-circle" cx="50" cy="50" r="45"/><path class="check-path" d="M30 50 L45 65 L70 35"/></svg></div>
                        </div>
                    </div>

                    <div class="card-top">
                        <div class="status-pill">
                            <span class="status-dot {{ 'printing' if dados.status == 'printing' else '' }}"></span>
                            <span class="status-text">{{ dados.msg }}</span>
                        </div>
                    </div>

                    <div class="printer-visual">
                        <img src="{{ url_for('static', filename='img/' + dados.imagem) }}" alt="Printer">
                    </div>

                    <div class="card-footer-info">
                        <div class="printer-titles"><h2>{{ dados.nome }}</h2><code class="ip-address">{{ ip }}</code></div>
                        <div class="progress-area" style="display: {{ 'block' if dados.status in ['printing', 'paused'] else 'none' }};">
                            <div class="progress-meta"><span>Progresso</span><span class="pct-val">{{ dados.progresso }}%</span></div>
                            <div class="progress-track"><div class="progress-fill barra-progresso" style="width: {{ dados.progresso }}%;"></div></div>
                        </div>
                    </div>
                </section>
                {% endfor %}
            </div>
        </main>
    </div>

    <div id="modalCadastro" class="modal-overlay glass">
        <div class="modal-window dashboard-modal">
            <header class="modal-header">
                <h2>Novos Par√¢metros da Farm</h2><button class="btn-close-modal" onclick="fecharModalCadastro()">&times;</button>
            </header>
            <div class="modal-body">
                <div class="input-modern"><label>Identifica√ß√£o</label><input type="text" id="nomeImpressora" placeholder="Ex: Neptune Max 01"></div>
                <div class="input-modern"><label>IP de Rede</label><input type="text" id="novoIpImpressora" placeholder="Ex: 100.114.160.35"></div>
            </div>
            <footer class="modal-footer"><button onclick="cadastrarNovaImpressora()" class="btn-primary-dashboard">CONFIRMAR CADASTRO</button></footer>
        </div>
    </div>

    <div id="modalImprimir" class="modal-overlay glass">
        <div class="modal-window command-center-modal">
            <header class="modal-header-cc">
                <div class="cc-title"><h2 id="tituloModal">Comandar Impressora</h2><span id="cc-ip-badge" class="ip-tag-cc">0.0.0.0</span></div>
                <nav class="cc-tabs">
                    <button class="tab-btn active" onclick="switchTab('monitor')">üìä Monitoramento</button>
                    <button class="tab-btn" onclick="switchTab('files')">üìÇ Arquivos & Mem√≥ria</button>
                </nav>

                <div class="header-actions" style="display: flex; gap: 10px;">
        <button id="btnDeletarImpressora" class="btn-delete-printer" title="Excluir esta impressora" onclick="confirmarExclusaoImpressora()">
            üóëÔ∏è
        </button>
      
    </div>
                <button class="btn-close-modal" onclick="fecharModal()">&times;</button>
            </header>

            <div class="modal-body-cc">
                <div id="tab-monitor" class="tab-content active">
                    <div class="cc-grid">
                        <div class="cc-panel telemetry-panel">
                            <h3>Controles de Hardware</h3>
                            <div class="temp-grid">
                                <div class="temp-card interactable" onclick="configurarTemperatura('extruder')">
                                    <span class="temp-label">üî• Extrusora</span>
                                    <div class="temp-value"><span id="temp-ext-cur">0</span>¬∞C <small>/ <span id="temp-ext-tar">0</span>¬∞C</small></div>
                                </div>
                                <div class="temp-card interactable" onclick="configurarTemperatura('heater_bed')">
                                    <span class="temp-label">üå°Ô∏è Mesa</span>
                                    <div class="temp-value"><span id="temp-bed-cur">0</span>¬∞C <small>/ <span id="temp-bed-tar">0</span>¬∞C</small></div>
                                </div>
                            </div>

                            <div class="cc-actions-row">
                                <button class="btn-cc-action pause" onclick="enviarComandoCC('PAUSE')">‚è∏</button>
                                <button class="btn-cc-action resume" onclick="enviarComandoCC('RESUME')">‚ñ∂</button>
                                <button class="btn-cc-action cancel" onclick="enviarComandoCC('CANCEL')">‚èπ</button>
                            </div>

                            <div class="movement-control-container">
                                <h4>Movimenta√ß√£o (Eixos X/Y)</h4>
                                <div class="d-pad">
                                    <button class="jog-btn up" onclick="moverImpressora('Y', 10)">‚Üë</button>
                                    <div class="jog-row">
                                        <button class="jog-btn left" onclick="moverImpressora('X', -10)">‚Üê</button>
                                        <button class="jog-btn home" onclick="enviarComandoCC('G28')">üè†</button>
                                        <button class="jog-btn right" onclick="moverImpressora('X', 10)">‚Üí</button>
                                    </div>
                                    <button class="jog-btn down" onclick="moverImpressora('Y', -10)">‚Üì</button>
                                </div>
                            </div>
                        </div>

                        <div class="cc-panel console-panel">
                            <h3>Console G-Code</h3>
                            <div id="cc-console-log" class="console-log"></div>
                        
                        </div>
                    </div> 
                </div>

                <div id="tab-files" class="tab-content">
                    <div class="cc-files-layout">
                        <div class="cc-file-section">
                            <h3>Biblioteca Central (Betim)</h3>
                            <div class="breadcrumb-glass">
                                <button id="btnVoltar" onclick="voltarPasta()" class="btn-icon-back">‚¨Ö</button>
                                <div id="caminhoAtual" class="path-display">/raiz</div>
                            </div>
                            <ul id="listaGcodes" class="file-grid-modern"></ul>
                            <div id="containerProgresso" class="upload-widget-modal" style="display: none;">
                                <div class="upload-labels"><span>Transmitindo...</span><strong id="porcentagemUploadTxt">0%</strong></div>
                                <div class="upload-bar-track"><div id="barraProgressoUpload" class="upload-bar-fill"></div></div>
                            </div>
                            <button id="btnEnviar" class="btn-primary-dashboard big" disabled>SELECIONE UM ARQUIVO</button>
                        </div>
                        <div class="cc-file-section internal-storage">
                            <h3>Mem√≥ria Interna (Klipper)</h3>
                            <ul id="listaArquivosInternos" class="internal-file-list">
                                <li class="loading-state">Lendo mem√≥ria...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div> </div>
    </div>

    <script>
        let impressoraSelecionada = '';
        let pastaAtual = '';
        let uploadsAtivos = {};
        let isPollingPaused = false;
        let pollingDeep = null;
        let nomeImpressoraSelecionada = ''; // Para usar na confirma√ß√£o de exclus√£o

        // 1. MONITORAMENTO GERAL (Grid e Widgets)
        function atualizarStatusInstantaneo() {
            if (isPollingPaused) return;
            fetch('/status_atualizado').then(r => r.json()).then(data => {
                document.getElementById('countDisp').innerText = data.total_disponiveis;
                const listaAtiva = document.getElementById('listaProducaoAtiva');
                let htmlLista = '';
                let temAlguemImprimindo = false;

                Object.entries(data.impressoras).forEach(([ip, dados]) => {
                    const card = document.querySelector(`.card-pro[onclick*="${ip}"]`);
                    if (card) {
                        card.className = `card-pro ${dados.cor}`;
                        const statusTxt = card.querySelector('.status-text');
                        if(statusTxt) statusTxt.innerText = dados.msg;
                        const infoDiv = card.querySelector('.progress-area');
                        if (['printing', 'paused'].includes(dados.status)) {
                            infoDiv.style.display = 'block';
                            card.querySelector('.barra-progresso').style.width = dados.progresso + '%';
                            card.querySelector('.pct-val').innerText = dados.progresso + '%';
                            temAlguemImprimindo = true;
                            const nomeLimpo = dados.arquivo.replace('.gcode', '').replace('.bgcode', '');
                            htmlLista += `<li><span class="printer-name">${dados.nome}</span><span class="file-name">${nomeLimpo}</span></li>`;
                        } else { infoDiv.style.display = 'none'; }
                    }
                });
                listaAtiva.innerHTML = temAlguemImprimindo ? htmlLista : '<li class="empty-msg">Nenhuma colmeia em produ√ß√£o</li>';
            });

            fetch('/dados_producao_diaria').then(r => r.json()).then(producao => {
                const listaConcluida = document.getElementById('listaProducaoConcluida');
                let htmlConcluido = '';
                Object.entries(producao.itens).forEach(([nome, qtd]) => {
                    htmlConcluido += `<li><span class="printer-name">${nome}</span><span class="file-name">Qtd: ${qtd}</span></li>`;
                });
                listaConcluida.innerHTML = htmlConcluido || '<li class="empty-msg">Aguardando finaliza√ß√µes...</li>';
            });
        }

        // 2. LOGICA DO COMMAND CENTER
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // 1. FUN√á√ÉO PARA CONFIRMAR EXCLUS√ÉO (Dentro do Modal)
function confirmarExclusaoImpressora() {
    if (impressoraSelecionada && nomeImpressoraSelecionada) {
        const confirmacao = confirm(`‚ö†Ô∏è ATEN√á√ÉO, ROBSON!\n\nTem certeza que deseja EXCLUIR a impressora "${nomeImpressoraSelecionada}" (IP: ${impressoraSelecionada})?\n\nEsta a√ß√£o remover√° a m√°quina permanentemente da sua farm em Betim.`);
        
        if (confirmacao) {
            removerImpressora(impressoraSelecionada, nomeImpressoraSelecionada);
        }
    }
}

function removerImpressora(ip, nome) {
    fetch('/remover_impressora', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip: ip })
    })
    .then(response => {
        if (response.ok) {
            fecharModal(); // Fecha o Command Center
            // Recarrega a p√°gina para atualizar o Grid de Betim
            window.location.reload(); 
        } else {
            alert("Erro ao remover a impressora. Verifique a conex√£o com o servidor.");
        }
    })
    .catch(err => console.error("Erro na exclus√£o:", err));
}

        function deepPollingCC() {
    if (!impressoraSelecionada) return;
    fetch(`/api/detalhes_profundos/${impressoraSelecionada}`)
        .then(r => r.json())
        .then(data => {
            // üõ°Ô∏è Valida√ß√£o: S√≥ tenta atualizar se os dados existirem na resposta
            if (data.status && data.status.extruder && data.status.heater_bed) {
                document.getElementById('temp-ext-cur').innerText = Math.round(data.status.extruder.temperature) || 0;
                document.getElementById('temp-ext-tar').innerText = Math.round(data.status.extruder.target) || 0;
                document.getElementById('temp-bed-cur').innerText = Math.round(data.status.heater_bed.temperature) || 0;
                document.getElementById('temp-bed-tar').innerText = Math.round(data.status.heater_bed.target) || 0;
            }

            // Atualiza Console
            const log = document.getElementById('cc-console-log');
            if (data.console && log) {
                log.innerHTML = data.console.map(line => `<div class="console-line"><span>></span> ${line.message}</div>`).join('');
                log.scrollTop = log.scrollHeight; // Auto-scroll para o final
            }
        }).catch(err => console.error("Erro no Deep Polling:", err));
}
        // 1. FUN√á√ÉO PARA FECHAR O MODAL (Resolve o erro do terminal)
function fecharModalCadastro() {
    const modal = document.getElementById('modalCadastro');
    if (modal) {
        modal.style.display = "none";
    }
}

// 2. FUN√á√ÉO PARA ABRIR E FOR√áAR O FUNDO PRETO
function abrirModalCadastro() {
    fecharModal(); // Fecha o Command Center antes de abrir o cadastro
    const modal = document.getElementById('modalCadastro');
    if (modal) {
        modal.style.display = "flex";
        // Mantendo seu "Force Background" que resolveu o problema do tablet
        modal.style.backgroundColor = "rgba(0, 0, 0, 0.9)";
        modal.style.backdropFilter = "blur(15px)";
    }
}

        function abrirModal(ip, nome) {
    fecharModalCadastro(); // Garante que a de cadastro feche antes
    impressoraSelecionada = ip;
    nomeImpressoraSelecionada = nome; // Salva o nome para a exclus√£o
    
    document.getElementById('modalImprimir').style.display = "flex";
    document.getElementById('tituloModal').innerText = nome;
    document.getElementById('cc-ip-badge').innerText = ip;
    document.getElementById('fullScreenSuccess').classList.remove('show');
    
    switchTab('monitor');
    carregarPasta(''); 
    carregarArquivosInternos(); 
    pollingDeep = setInterval(deepPollingCC, 2000);
}

        function fecharModal() {
            document.getElementById('modalImprimir').style.display = "none";
            clearInterval(pollingDeep);
            impressoraSelecionada = '';
        }

        // 3. LOGICA DE ARQUIVOS (INTERNOS E EXTERNOS)
        function carregarPasta(caminho) {
            fetch('/navegar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ pasta: caminho })
            }).then(r => r.json()).then(dados => {
                pastaAtual = dados.atual;
                const ul = document.getElementById('listaGcodes');
                ul.innerHTML = '';
                document.getElementById('caminhoAtual').innerText = dados.atual || 'Raiz';
                document.getElementById('btnVoltar').disabled = (dados.atual === '');
                
                dados.pastas.forEach(p => {
                    const li = document.createElement('li');
                    li.className = 'item-folder';
                    li.innerHTML = `üìÅ ${p}`;
                    li.onclick = () => carregarPasta(pastaAtual + (pastaAtual ? '\\' : '') + p);
                    ul.appendChild(li);
                });
                dados.arquivos.forEach(arq => {
                    const li = document.createElement('li');
                    li.className = 'item-file';
                    li.innerHTML = `üìÑ ${arq}`;
                    li.onclick = () => selecionarArquivo(li, arq);
                    ul.appendChild(li);
                });
            });
        }
        // FUN√á√ÉO PARA ENVIAR O CADASTRO PARA O BACKEND
function cadastrarNovaImpressora() {
    const nome = document.getElementById('nomeImpressora').value;
    const ip = document.getElementById('novoIpImpressora').value;

    // Valida√ß√£o b√°sica para n√£o enviar campos vazios
    if (!nome || !ip) {
        alert("‚ö†Ô∏è Por favor, preencha o Nome e o IP da impressora.");
        return;
    }

    console.log(`Enviando cadastro: ${nome} - ${ip}`);

    fetch('/cadastrar_impressora', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome: nome, ip: ip })
    })
    .then(response => {
        if (response.ok) {
            // Sucesso! Fecha o modal e recarrega a p√°gina para mostrar a nova m√°quina
            fecharModalCadastro();
            window.location.reload(); 
        } else {
            alert("‚ùå Erro ao cadastrar. Verifique se o IP j√° existe ou a conex√£o com o servidor.");
        }
    })
    .catch(err => {
        console.error("Erro na requisi√ß√£o de cadastro:", err);
        alert("üö® Falha cr√≠tica ao conectar com o servidor de Betim.");
    });
}

        function selecionarArquivo(el, nome) {
            document.querySelectorAll('.item-file').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
            const btn = document.getElementById('btnEnviar');
            btn.disabled = false;
            btn.dataset.arquivo = pastaAtual + (pastaAtual ? '\\' : '') + nome;
            btn.innerText = "INICIAR PRODU√á√ÉO";
        }

        function carregarArquivosInternos() {
    const lista = document.getElementById('listaArquivosInternos');
    // Adiciona um feedback visual de carregamento
    lista.innerHTML = '<li class="loading-state">Lendo mem√≥ria da impressora...</li>';

    fetch(`/api/arquivos_internos/${impressoraSelecionada}`)
        .then(r => r.json())
        .then(arquivos => {
            if (arquivos.length === 0) {
                lista.innerHTML = '<li class="empty-msg">Nenhum arquivo na mem√≥ria.</li>';
                return;
            }

            lista.innerHTML = arquivos.map(f => {
                // üõ°Ô∏è O SEGREDO: Testamos qual chave existe (path ou name)
                const nomeArquivo = f.path || f.name || "Arquivo s/ nome";
                const tamanhoMB = (f.size / 1024 / 1024).toFixed(1);

                return `
                    <li class="internal-file-item">
                        <div class="file-info">
                            <strong class="file-name-text">${nomeArquivo}</strong>
                            <small class="file-size-tag">${tamanhoMB} MB</small>
                        </div>
                        <button class="btn-print-internal" onclick="enviarComandoCC('START_PRINT', '${nomeArquivo}')">
                            IMPRIMIR
                        </button>
                    </li>
                `;
            }).join('');
        })
        .catch(err => {
            console.error("Erro ao ler Klipper:", err);
            lista.innerHTML = '<li class="error-msg">Erro ao conectar com a impressora.</li>';
        });
}

        // 4. ENVIO E COMANDOS
        document.getElementById('btnEnviar').onclick = function() {
            const arquivo = this.dataset.arquivo;
            const ip = impressoraSelecionada;
            const idLimpo = ip.split('.').join('-');
            fecharModal();
            
            document.getElementById(`loader-${idLimpo}`).style.display = 'flex';
            fetch('/imprimir', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ip: ip, arquivo: arquivo })
            });

            uploadsAtivos[ip] = setInterval(() => {
                fetch(`/progresso_transmissao/${ip}`).then(r => r.json()).then(d => {
                    document.getElementById(`fill-${idLimpo}`).style.width = d.p + '%';
                    document.getElementById(`pct-${idLimpo}`).innerText = d.p + '%';
                    if(d.p >= 100) {
                        clearInterval(uploadsAtivos[ip]);
                        document.getElementById(`content-${idLimpo}`).style.display = 'none';
                        document.getElementById(`success-${idLimpo}`).style.display = 'flex';
                        setTimeout(() => { document.getElementById(`loader-${idLimpo}`).style.display = 'none'; }, 3000);
                    }
                });
            }, 800);
        };

        function enviarComandoCC(cmd, params = '') {
            fetch('/api/comando_gcode', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ip: impressoraSelecionada, comando: cmd, extra: params })
            });
        }

        function toggleStatusDrawer() {
            const drawer = document.querySelector('.summary-widgets');
            drawer.classList.toggle('drawer-open');
            document.getElementById('statusOverlay').classList.toggle('active');
        }

        setInterval(atualizarStatusInstantaneo, 3000);

        // 1. Configura√ß√£o de Temperatura Interativa
function configurarTemperatura(tipo) {
    const statusAtual = document.querySelector(`.card-pro[onclick*="${impressoraSelecionada}"]`).className;
    
    // üõ°Ô∏è Seguran√ßa: Bloqueia se estiver imprimindo
    if (statusAtual.includes('printing')) {
        alert("‚ö†Ô∏è Opera√ß√£o bloqueada! N√£o √© poss√≠vel alterar a temperatura durante a impress√£o.");
        return;
    }

    const valor = prompt(`Definir temperatura para ${tipo === 'extruder' ? 'Bico' : 'Mesa'} (¬∞C):`);
    if (valor && !isNaN(valor)) {
        const cmd = tipo === 'extruder' ? `M104 S${valor}` : `M140 S${valor}`;
        enviarComandoCC(cmd);
    }
}

// 2. L√≥gica de Movimenta√ß√£o Relativa
function moverImpressora(eixo, distancia) {
    // üõ°Ô∏è Seguran√ßa: Impede movimenta√ß√£o manual em produ√ß√£o
    const statusAtivo = document.querySelector(`.card-pro[onclick*="${impressoraSelecionada}"]`).className;
    if (statusAtivo.includes('printing')) return;

    // Envia sequ√™ncia: Modo Relativo -> Mover -> Modo Absoluto (Seguran√ßa)
    const gcode = `G91\nG1 ${eixo}${distancia} F3000\nG90`;
    enviarComandoCC(gcode);
}

function paradaDeEmergencia(ip, nome) {
    // üõ°Ô∏è Trava de Seguran√ßa: Evita cliques acidentais
    const confirmar = confirm(`üö® PARADA DE EMERG√äNCIA!\n\nTem certeza que deseja BLOQUEAR IMEDIATAMENTE a impressora "${nome}"?\n\nIsso cancelar√° a impress√£o e desligar√° os motores.`);

    if (confirmar) {
        console.log(`!!! DISPARANDO M112 PARA ${ip} !!!`);
        
        // Envia o comando G-Code de emerg√™ncia (M112)
        fetch('/api/comando_gcode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                ip: ip, 
                comando: 'M112' 
            })
        }).then(response => {
            if (response.ok) {
                alert("üî¥ Comando de Emerg√™ncia Enviado! A m√°quina foi interrompida.");
                window.location.reload();
            }
        });
    }
}
    </script>
</body>
</html>