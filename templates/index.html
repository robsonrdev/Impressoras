<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel de Controle 3D - PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div id="fullScreenSuccess" class="fullscreen-overlay">
        <div class="success-content">
            <div class="sophisticated-check">
                <svg viewBox="0 0 100 100">
                    <circle class="bg-circle" cx="50" cy="50" r="45"/>
                    <path class="check-path" d="M30 50 L45 65 L70 35"/>
                </svg>
            </div>
            <h1 class="success-title">Concluido</h1>
            <p id="subtituloSucesso" class="success-subtitle">Preparando impressora</p>
        </div>
    </div>

    <header class="main-header">
        <div class="header-container">
            <div class="logo-area">
                <img src="/static/img/logo.png" alt="Logo" class="company-logo">
            </div>
            <div class="stats-bar">
                <div class="stat-group">
                    <span class="stat-item">üü¢ Prontas: <strong id="countDisp">{{ disponiveis }}</strong></span>
                </div>
            </div>
            <div class="header-title">
                <h1>Central de Impress√£o <span class="highlight">PRO</span></h1>
                <p>Monitoramento de Farm - Betim</p>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="grid-responsive">
            {% for ip, dados in impressoras.items() %}
            <section class="card {{ dados.cor }}" onclick="abrirModal('{{ ip }}', '{{ dados.nome }}')">
                <div class="card-header-row">
                    <span class="badge-id">#{{ loop.index }}</span>
                    <div class="status-badge">
                        <span class="status-dot {{ 'printing' if dados.status == 'printing' else '' }}"></span>
                        <span class="status-label status-text">{{ dados.msg }}</span>
                    </div>
                </div>

                <div class="card-body-row">
                    <div class="printer-thumb">
                        <img src="{{ url_for('static', filename='img/' + dados.imagem) }}" alt="Printer">
                    </div>
                    <div class="printer-info">
                        <h2>{{ dados.modelo_real }}</h2>
                        <code class="ip-tag">{{ ip }}</code>
                    </div>
                </div>

                <div class="info-impressao" style="display: {{ 'block' if dados.status in ['printing', 'paused'] else 'none' }};">
                    <div class="progress-section">
                        <div class="progress-bar-track">
                            <div class="progress-bar-fill barra-progresso" style="width: {{ dados.progresso }}%;"></div>
                        </div>
                    </div>
                </div>
            </section>
            {% endfor %}
        </div>
    </main>

    <div id="modalImprimir" class="modal-overlay">
        <div class="modal-window">
            <header class="modal-header">
                <h2 id="tituloModal">Selecionar Arquivo</h2>
                <button class="close-btn" onclick="fecharModal()">&times;</button>
            </header>

            <div class="breadcrumb-bar">
                <button id="btnVoltar" onclick="voltarPasta()" class="btn-back" disabled>‚¨Ö Voltar</button>
                <div class="path-display" id="caminhoAtual">/raiz</div>
            </div>

            <div class="file-explorer-container">
                <ul id="listaGcodes" class="file-list">
                    <li class="loading-state">Conectando...</li>
                </ul>
            </div>

            <div id="containerProgresso" class="upload-container" style="display: none;">
                <div class="progress-label-row">
                    <span id="statusUploadTxt">Transmitindo...</span>
                    <span id="porcentagemUploadTxt">0%</span>
                </div>
                <div class="upload-track">
                    <div id="barraProgressoUpload" class="upload-fill"></div>
                </div>
            </div>

            <footer class="modal-footer">
                <button id="btnEnviar" class="btn-action" disabled>SELECIONE UM ARQUIVO</button>
            </footer>
        </div>
    </div>

<script>
    // --- ESTADO GLOBAL √öNICO ---
    let impressoraSelecionada = '';
    let pastaAtual = '';
    let pollingUpload = null;
    let isPollingPaused = false; // üöÄ Chave para foco total no upload

    // --- 1. Sincroniza√ß√£o de Status (Dashboard) ---
    function atualizarStatusInstantaneo() {
        // Se estivermos enviando um arquivo, pausamos o monitoramento geral
        if (isPollingPaused) return; 

        fetch('/status_atualizado')
            .then(r => r.json())
            .then(data => {
                const dispEl = document.getElementById('countDisp');
                if(dispEl) dispEl.innerText = data.total_disponiveis;

                Object.entries(data.impressoras).forEach(([ip, dados]) => {
                    const card = document.querySelector(`.card[onclick*="${ip}"]`);
                    if (!card) return;

                    card.className = `card ${dados.cor}`;
                    const dot = card.querySelector('.status-dot');
                    if(dot) dot.className = `status-dot ${dados.status === 'printing' ? 'printing' : ''}`;
                    
                    const statusTxt = card.querySelector('.status-text');
                    if(statusTxt) statusTxt.innerText = dados.msg;

                    const infoDiv = card.querySelector('.info-impressao');
                    if (['printing', 'paused'].includes(dados.status)) {
                        infoDiv.style.display = 'block';
                        card.querySelector('.barra-progresso').style.width = dados.progresso + '%';
                    } else {
                        infoDiv.style.display = 'none';
                    }
                });
            }).catch(err => console.error("Erro na telemetria:", err));
    }
    setInterval(atualizarStatusInstantaneo, 2000);

    // --- 2. Gest√£o do Modal e Navega√ß√£o (Original) ---
    function abrirModal(ip, nome) {
        impressoraSelecionada = ip;
        document.getElementById('modalImprimir').style.display = "flex";
        document.getElementById('tituloModal').innerText = `Comandar: ${nome}`;
        document.querySelector('.close-btn').style.visibility = 'visible';
        document.querySelector('.file-explorer-container').style.display = 'block';
        document.getElementById('containerProgresso').style.display = 'none';
        document.getElementById('btnEnviar').style.display = 'block';
        document.getElementById('fullScreenSuccess').classList.remove('show');
        pastaAtual = '';
        carregarPasta(''); 
        resetBotaoEnviar();
    }

    function carregarPasta(caminho) {
        const ul = document.getElementById('listaGcodes');
        ul.innerHTML = '<li class="loading-msg">Consultando...</li>';
        fetch('/navegar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ pasta: caminho })
        }).then(r => r.json()).then(dados => {
            pastaAtual = dados.atual;
            renderizarArquivos(dados);
        });
    }

    function renderizarArquivos(dados) {
        const ul = document.getElementById('listaGcodes');
        ul.innerHTML = ''; 
        document.getElementById('caminhoAtual').innerText = dados.atual || 'Raiz (gcodes)';
        document.getElementById('btnVoltar').disabled = (dados.atual === '');
        dados.pastas.forEach(p => {
            const li = document.createElement('li');
            li.className = 'item-pasta';
            li.innerHTML = `<span>üìÅ</span> <strong>${p}</strong>`;
            li.onclick = () => carregarPasta(pastaAtual + (pastaAtual ? '\\' : '') + p);
            ul.appendChild(li);
        });
        dados.arquivos.forEach(arq => {
            const li = document.createElement('li');
            li.className = 'item-arquivo';
            li.innerHTML = `<span>üìÑ</span> ${arq}`;
            li.onclick = () => selecionarArquivo(li, arq);
            ul.appendChild(li);
        });
    }

    function selecionarArquivo(elemento, nomeArquivo) {
        document.querySelectorAll('#listaGcodes li').forEach(i => i.classList.remove('selecionado'));
        elemento.classList.add('selecionado');
        const btn = document.getElementById('btnEnviar');
        btn.disabled = false;
        btn.classList.add('active');
        btn.dataset.arquivo = pastaAtual + (pastaAtual ? '\\' : '') + nomeArquivo; 
        btn.innerText = `IMPRIMIR AGORA`;
    }

    function voltarPasta() {
        const partes = pastaAtual.split('\\');
        partes.pop();
        carregarPasta(partes.join('\\'));
    }

    function resetBotaoEnviar() {
        const btn = document.getElementById('btnEnviar');
        btn.disabled = true;
        btn.classList.remove('active');
        btn.innerText = "SELECIONE UM ARQUIVO";
    }

    // --- 3. Execu√ß√£o de Envio com Foco Total ---
    document.getElementById('btnEnviar').onclick = function() {
        const arquivo = this.dataset.arquivo;
        const ip = impressoraSelecionada;
        const nomeImpressora = document.getElementById('tituloModal').innerText.replace('Comandar: ', '');
        
        // üõë O confirm vem antes para n√£o pausar o sistema desnecessariamente
        if(!confirm(`Iniciar impress√£o de: ${arquivo}?`)) return;

        // üöÄ ATIVA O FOCO TOTAL: Pausa atualiza√ß√µes de status para priorizar o upload
        isPollingPaused = true;

        document.querySelector('.file-explorer-container').style.display = 'none';
        document.getElementById('containerProgresso').style.display = 'block';
        document.querySelector('.close-btn').style.visibility = 'hidden';
        this.disabled = true;
        this.innerText = "AGUARDE...";

        fetch('/imprimir', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ip: ip, arquivo: arquivo })
        })
        .then(r => r.json())
        .then(res => {
            if(res.success) {
                pollingUpload = setInterval(() => {
                    fetch(`/progresso_transmissao/${ip}`)
                    .then(r => r.json())
                    .then(d => {
                        let p = d.p; 
                        let msg = d.msg; 
                        
                        // Tratamento de erro retornado pela impressora
                        if (p === -1) {
                            alert("Erro: " + msg);
                            clearInterval(pollingUpload);
                            pollingUpload = null;
                            isPollingPaused = false; // üîì Retoma monitoramento
                            fecharModal();
                            return;
                        }

                        document.getElementById('barraProgressoUpload').style.width = p + '%';
                        document.getElementById('porcentagemUploadTxt').innerText = p + '%';
                        document.getElementById('statusUploadTxt').innerText = msg;

                        // Gatilho de Sucesso (Transmiss√£o Conclu√≠da)
                        if(p >= 100) {
                            clearInterval(pollingUpload);
                            pollingUpload = null; 

                            const overlay = document.getElementById('fullScreenSuccess');
                            const subtitulo = document.getElementById('subtituloSucesso');
                            subtitulo.innerText = `Preparando ${nomeImpressora}!`;
                            subtitulo.style.color = "#fff";

                            overlay.classList.add('show');
                            fecharModal(); 

                            setTimeout(() => {
                                overlay.classList.remove('show');
                                // üîì SUCESSO: Retoma o monitoramento global
                                isPollingPaused = false; 
                                atualizarStatusInstantaneo(); 
                            }, 3500);
                        }
                    })
                    .catch(err => {
                        // üîì ERRO DE REDE: Destrava para n√£o "congelar" o painel
                        console.error("Erro no polling de upload:", err);
                        clearInterval(pollingUpload);
                        pollingUpload = null;
                        isPollingPaused = false; 
                        fecharModal();
                    });
                }, 800);
            } else { 
                alert("Erro: " + res.message); 
                isPollingPaused = false; // üîì Retoma status se o envio falhar
                fecharModal(); 
            }
        }).catch(err => {
            isPollingPaused = false; // üîì Retoma status em erro de rede inicial
            console.error(err);
        });
    };

    function fecharModal() {
        if (pollingUpload) return; 
        document.getElementById('modalImprimir').style.display = "none";
    }

    window.onclick = e => { 
        if (e.target.id === 'modalImprimir') {
            if (!pollingUpload) fecharModal(); 
            else {
                const win = document.querySelector('.modal-window');
                win.style.border = '2px solid #ff9800';
                setTimeout(() => win.style.border = '1px solid #444', 300);
            }
        }
    };
</script>
</body>
</html>