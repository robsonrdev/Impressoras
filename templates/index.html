<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel de Controle 3D - PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <div class="logo-area">
                <img src="/static/img/logo.png" alt="Logo" class="company-logo" onerror="this.style.backgroundColor='#333';">
            </div>
            
            <div class="stats-bar">
                <div class="stat-group">
                    <span class="stat-item">üü¢ Impressoras Prontas: <strong id="countDisp">{{ disponiveis }}</strong></span>
                </div>
            </div>

            <div class="header-title">
                <h1>Central de Impress√£o <span class="highlight">PRO</span></h1>
                <p>Monitoramento e Controle de Farm</p>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="grid-responsive">
            {% for ip, dados in impressoras.items() %}
            <section class="card {{ dados.cor }}" onclick="abrirModal('{{ ip }}', '{{ dados.nome }}')">
                <div class="card-header-row">
                    <span class="badge-id">#{{ loop.index }}</span>
                    <div class="status-badge">
                        <span class="status-dot {{ 'printing' if dados.status == 'printing' else '' }}"></span>
                        <span class="status-label status-text">{{ dados.msg }}</span>
                    </div>
                </div>

                <div class="card-body-row">
                    <div class="printer-thumb">
                        <img src="{{ url_for('static', filename='img/' + dados.imagem) }}" alt="Printer">
                    </div>
                    <div class="printer-info">
                        <h2>{{ dados.modelo_real }}</h2>
                        <code class="ip-tag">{{ ip }}</code>
                    </div>
                </div>

                <div class="info-impressao" style="display: {{ 'block' if dados.status in ['printing', 'paused'] else 'none' }};">
                    <div class="progress-section">
                        <div class="progress-info">
                            <span class="file-name nome-arquivo">üìÑ {{ dados.arquivo }}</span>
                        </div>
                        <div class="progress-bar-track">
                            <div class="progress-bar-fill barra-progresso" style="width: {{ dados.progresso }}%;"></div>
                        </div>
                    </div>
                </div>
            </section>
            {% endfor %}
        </div>
    </main>

    <div id="modalImprimir" class="modal-overlay">
        <div class="modal-window">
            <header class="modal-header">
                <h2 id="tituloModal">Selecionar Arquivo</h2>
                <button class="close-btn" onclick="fecharModal()">&times;</button>
            </header>

            <div class="breadcrumb-bar">
                <button id="btnVoltar" onclick="voltarPasta()" class="btn-back" disabled>
                    <span>‚¨Ö</span> Voltar
                </button>
                <div class="path-display" id="caminhoAtual">/raiz</div>
            </div>

            <div class="file-explorer-container">
                <ul id="listaGcodes" class="file-list">
                    <li class="loading-state">Conectando...</li>
                </ul>
            </div>

            <div id="containerProgresso" class="upload-container" style="display: none;">
                <div class="progress-label-row">
                    <span id="statusUploadTxt">Iniciando...</span>
                    <span id="porcentagemUploadTxt">0%</span>
                </div>
                <div class="upload-track">
                    <div id="barraProgressoUpload" class="upload-fill"></div>
                </div>
            </div>

            <footer class="modal-footer">
                <button id="btnEnviar" class="btn-action" disabled>SELECIONE UM ARQUIVO</button>
            </footer>
        </div>
    </div>

    <script>
        let impressoraSelecionada = '';
        let pastaAtual = '';
        let pollingUpload = null;

        function atualizarStatusInstantaneo() {
            fetch('/status_atualizado')
                .then(r => r.json())
                .then(data => {
                    const dispEl = document.getElementById('countDisp');
                    if(dispEl) dispEl.innerText = data.total_disponiveis;

                    Object.entries(data.impressoras).forEach(([ip, dados]) => {
                        const card = document.querySelector(`.card[onclick*="${ip}"]`);
                        if (!card) return;

                        card.className = `card ${dados.cor}`;
                        const dot = card.querySelector('.status-dot');
                        if(dot) dot.className = `status-dot ${dados.status === 'printing' ? 'printing' : ''}`;
                        
                        const statusTxt = card.querySelector('.status-text');
                        if(statusTxt) statusTxt.innerText = dados.msg;

                        const infoDiv = card.querySelector('.info-impressao');
                        if (['printing', 'paused'].includes(dados.status)) {
                            infoDiv.style.display = 'block';
                            card.querySelector('.nome-arquivo').innerText = dados.arquivo;
                            card.querySelector('.barra-progresso').style.width = `${dados.progresso}%`;
                        } else {
                            infoDiv.style.display = 'none';
                        }
                    });
                })
                .catch(err => console.error("Erro na telemetria:", err));
        }
        setInterval(atualizarStatusInstantaneo, 2000);

        function abrirModal(ip, nome) {
            impressoraSelecionada = ip;
            document.getElementById('modalImprimir').style.display = "flex";
            document.getElementById('tituloModal').innerText = `Comandar: ${nome}`;
            document.querySelector('.file-explorer-container').style.display = 'block';
            document.getElementById('containerProgresso').style.display = 'none';
            document.getElementById('btnEnviar').style.display = 'block';
            pastaAtual = '';
            carregarPasta(''); 
            resetBotaoEnviar();
        }

        function carregarPasta(caminho) {
            const ul = document.getElementById('listaGcodes');
            ul.innerHTML = '<li class="loading-msg">Consultando...</li>';
            fetch('/navegar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ pasta: caminho })
            }).then(r => r.json()).then(dados => {
                pastaAtual = dados.atual;
                renderizarArquivos(dados);
            });
        }

        function renderizarArquivos(dados) {
            const ul = document.getElementById('listaGcodes');
            ul.innerHTML = ''; 
            document.getElementById('caminhoAtual').innerText = dados.atual || 'Raiz (gcodes)';
            document.getElementById('btnVoltar').disabled = (dados.atual === '');
            dados.pastas.forEach(p => {
                const li = document.createElement('li');
                li.className = 'item-pasta';
                li.innerHTML = `<span>üìÅ</span> <strong>${p}</strong>`;
                li.onclick = () => carregarPasta(pastaAtual + (pastaAtual ? '\\' : '') + p);
                ul.appendChild(li);
            });
            dados.arquivos.forEach(arq => {
                const li = document.createElement('li');
                li.className = 'item-arquivo';
                li.innerHTML = `<span>üìÑ</span> ${arq}`;
                li.onclick = () => selecionarArquivo(li, arq);
                ul.appendChild(li);
            });
        }

        function selecionarArquivo(elemento, nomeArquivo) {
            document.querySelectorAll('#listaGcodes li').forEach(i => i.classList.remove('selecionado'));
            elemento.classList.add('selecionado');
            const btn = document.getElementById('btnEnviar');
            btn.disabled = false;
            btn.classList.add('active');
            btn.dataset.arquivo = pastaAtual + (pastaAtual ? '\\' : '') + nomeArquivo; 
            btn.innerText = `IMPRIMIR AGORA`;
        }

        function voltarPasta() {
            const partes = pastaAtual.split('\\');
            partes.pop();
            carregarPasta(partes.join('\\'));
        }

        function resetBotaoEnviar() {
            const btn = document.getElementById('btnEnviar');
            btn.disabled = true;
            btn.classList.remove('active');
            btn.innerText = "SELECIONE UM ARQUIVO";
        }

        document.getElementById('btnEnviar').onclick = function() {
            const arquivo = this.dataset.arquivo;
            const ip = impressoraSelecionada;
            if(!confirm(`Iniciar impress√£o de: ${arquivo}?`)) return;

            document.querySelector('.file-explorer-container').style.display = 'none';
            document.getElementById('containerProgresso').style.display = 'block';
            this.disabled = true;
            this.innerText = "AGUARDE...";
            this.classList.add('loading');

            fetch('/imprimir', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ip: ip, arquivo: arquivo })
            })
            .then(r => r.json())
            .then(res => {
                if(res.success) {
                    pollingUpload = setInterval(() => {
                        fetch(`/progresso_transmissao/${ip}`)
                        .then(r => r.json())
                        .then(d => {
                            let p = d.p; 
                            let msg = d.msg; 

                            if (p === -1) {
                                alert("Erro: " + msg);
                                clearInterval(pollingUpload);
                                fecharModal();
                                return;
                            }

                            document.getElementById('barraProgressoUpload').style.width = p + '%';
                            document.getElementById('porcentagemUploadTxt').innerText = p + '%';
                            document.getElementById('statusUploadTxt').innerText = msg;

                            if(p >= 100) {
                                clearInterval(pollingUpload);
                                setTimeout(() => {
                                    fecharModal();
                                    atualizarStatusInstantaneo();
                                }, 1500);
                            }
                        });
                    }, 800);
                } else {
                    alert("Erro: " + res.message);
                    fecharModal();
                }
            });
        };

        function fecharModal() {
            if (pollingUpload) clearInterval(pollingUpload);
            document.getElementById('modalImprimir').style.display = "none";
        }
        
        window.onclick = e => { if (e.target.id === 'modalImprimir') fecharModal(); };
    </script>
</body>
</html>