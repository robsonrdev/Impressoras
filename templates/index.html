<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel de Controle 3D</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <div class="logo-area">
                <img src="/static/img/logo.png" alt="Logo da Empresa" class="company-logo" onerror="this.style.backgroundColor='#333'; this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'50\' height=\'50\'><text x=\'50%\' y=\'50%\' fill=\'%23ff6d00\' dominant-baseline=\'middle\' text-anchor=\'middle\'>LOGO</text></svg>';">
            </div>
            <div class="header-title">
                <h1>Central de Impress√£o <span class="highlight">PRO</span></h1>
                <p>Monitoramento e Controle de Farm</p>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="grid-responsive">
            {% for ip, dados in impressoras.items() %}
            <section class="card" data-status="{{ dados.status }}" onclick="abrirModal('{{ ip }}', '{{ dados.nome }}')">
                <div class="card-header-row">
                    <span class="badge-id">#{{ loop.index }}</span>
                    <div class="status-badge">
                        <span class="status-dot"></span>
                        <span class="status-label">{{ dados.msg }}</span>
                    </div>
                </div>

                <div class="card-body-row">
                    <div class="printer-thumb">
                        <img src="{{ url_for('static', filename='img/' + dados.imagem) }}" alt="{{ dados.modelo_real }}">
                    </div>
                    
                    <div class="printer-info">
                        <h2>{{ dados.modelo_real }}</h2>
                        <code class="ip-tag">{{ ip }}</code>
                    </div>
                </div>

                {% if dados.status in ['printing', 'paused'] %}
                <div class="progress-section">
                    <div class="progress-info">
                        <span class="file-name">üìÑ {{ dados.arquivo }}</span>
                        <span class="percentage-text">{{ dados.progresso }}%</span>
                    </div>
                    <div class="progress-bar-track">
                        <div class="progress-bar-fill" style="width: {{ dados.progresso }}%;"></div>
                    </div>
                </div>
                {% endif %}
            </section>
            {% endfor %}
        </div>
    </main>

    <div id="modalImprimir" class="modal-overlay">
        <div class="modal-window">
            <header class="modal-header">
                <h2 id="tituloModal">Selecionar Arquivo</h2>
                <button class="close-btn" onclick="fecharModal()" aria-label="Fechar">&times;</button>
            </header>

            <div class="breadcrumb-bar">
                <button id="btnVoltar" onclick="voltarPasta()" class="btn-back" disabled>
                    <span class="icon">‚¨Ö</span> Voltar
                </button>
                <div class="path-display" id="caminhoAtual">/raiz</div>
            </div>

            <div class="file-explorer-container">
                <ul id="listaGcodes" class="file-list">
                    <li class="loading-state">Conectando ao servidor...</li>
                </ul>
            </div>

            <footer class="modal-footer">
                <button id="btnEnviar" class="btn-action" disabled>CONFIRMAR IMPRESS√ÉO</button>
            </footer>
        </div>
    </div>

    <script>
        let impressoraSelecionada = '';
        let pastaAtual = '';

        // --- 1. Sincroniza√ß√£o de Status ---
        function atualizarStatusInstantaneo() {
            fetch('/status_atualizado')
                .then(r => r.json())
                .then(impressoras => {
                    Object.entries(impressoras).forEach(([ip, dados]) => {
                        const card = document.querySelector(`.card[onclick*="${ip}"]`);
                        if (!card) return;

                        // Atualiza estado visual
                        card.className = `card ${dados.cor}`;
                        const dot = card.querySelector('.status-dot');
                        dot.className = `status-dot ${dados.status === 'printing' ? 'printing' : ''}`;
                        
                        card.querySelector('.status-text').innerText = dados.msg;

                        const infoDiv = card.querySelector('.info-impressao');
                        if (['printing', 'paused'].includes(dados.status)) {
                            infoDiv.style.display = 'block';
                            card.querySelector('.nome-arquivo').innerText = dados.arquivo;
                            card.querySelector('.barra-progresso').style.width = `${dados.progresso}%`;
                        } else {
                            infoDiv.style.display = 'none';
                        }
                    });
                })
                .catch(err => console.error("Falha na telemetria:", err));
        }

        setInterval(atualizarStatusInstantaneo, 2000);

        // --- 2. Navega√ß√£o de Arquivos (FS Remoto) ---
        function abrirModal(ip, nome) {
            impressoraSelecionada = ip;
            document.getElementById('modalImprimir').style.display = "flex";
            document.getElementById('tituloModal').innerText = `Comandar: ${nome}`;
            
            pastaAtual = '';
            carregarPasta(''); 
            resetBotaoEnviar();
        }

        function carregarPasta(caminho) {
            const ul = document.getElementById('listaGcodes');
            ul.innerHTML = '<li class="loading-msg">Consultando servidor...</li>';

            fetch('/navegar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ pasta: caminho })
            })
            .then(r => r.json())
            .then(dados => {
                if(dados.erro) throw new Error(dados.erro);
                pastaAtual = dados.atual;
                renderizarArquivos(dados);
            })
            .catch(e => {
                ul.innerHTML = `<li style="color: #ff5252; padding: 15px;">‚ö†Ô∏è Erro: ${e.message}</li>`;
            });
        }

        function renderizarArquivos(dados) {
            const ul = document.getElementById('listaGcodes');
            ul.innerHTML = ''; 
            
            document.getElementById('caminhoAtual').innerText = dados.atual || 'Raiz (gcodes)';
            document.getElementById('btnVoltar').disabled = (dados.atual === '');

            // Renderizar Pastas
            dados.pastas.forEach(p => {
                const li = document.createElement('li');
                li.className = 'item-pasta';
                li.innerHTML = `<span>üìÅ</span> <strong>${p}</strong>`;
                li.onclick = () => carregarPasta(pastaAtual + (pastaAtual ? '\\' : '') + p);
                ul.appendChild(li);
            });

            // Renderizar Gcodes
            dados.arquivos.forEach(arq => {
                const li = document.createElement('li');
                li.className = 'item-arquivo';
                li.innerHTML = `<span>üìÑ</span> ${arq}`;
                li.onclick = () => selecionarArquivo(li, arq);
                ul.appendChild(li);
            });

            if (!dados.pastas.length && !dados.arquivos.length) {
                ul.innerHTML = '<li class="empty-msg">Nenhum arquivo .gcode encontrado.</li>';
            }
        }

        function selecionarArquivo(elemento, nomeArquivo) {
            document.querySelectorAll('#listaGcodes li').forEach(i => i.classList.remove('selecionado'));
            elemento.classList.add('selecionado');
            
            const btn = document.getElementById('btnEnviar');
            btn.disabled = false;
            btn.className = 'btn-enviar active';
            btn.dataset.arquivo = pastaAtual + (pastaAtual ? '\\' : '') + nomeArquivo; 
            btn.innerText = `IMPRIMIR: ${nomeArquivo}`;
        }

        function voltarPasta() {
            if(!pastaAtual) return;
            const partes = pastaAtual.split('\\');
            partes.pop();
            carregarPasta(partes.join('\\'));
        }

        function resetBotaoEnviar() {
            const btn = document.getElementById('btnEnviar');
            btn.disabled = true;
            btn.className = 'btn-bloqueado';
            btn.innerText = "SELECIONE UM ARQUIVO";
        }

        // --- 3. Execu√ß√£o de Impress√£o ---
        document.getElementById('btnEnviar').onclick = function() {
            const arquivo = this.dataset.arquivo;
            if(!confirm(`Deseja iniciar a impress√£o de: ${arquivo}?`)) return;
            
            fetch('/imprimir', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ip: impressoraSelecionada, arquivo: arquivo })
            })
            .then(r => r.json())
            .then(res => {
                if(res.success) {
                    fecharModal();
                } else {
                    alert("Erro no servidor: " + res.message);
                }
            });
        };

        function fecharModal() {
            document.getElementById('modalImprimir').style.display = "none";
        }
        
        window.onclick = e => { if (e.target.id === 'modalImprimir') fecharModal(); };
    </script>

</body>
</html>